<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ãƒ¡ãƒ¢</title>
    
    <!-- iOSãƒ›ãƒ¼ãƒ ç”»é¢ç”¨è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ãƒ¡ãƒ¢">
    <!-- iPhoneã®æ¨™æº–ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªé¢¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Apple_Notes_icon.svg/1024px-Apple_Notes_icon.svg.png">

    <!-- Firebase SDK (ESM) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ================================================================
        // ã€é‡è¦ã€‘Vercelã§å‹•ã‹ã™ãŸã‚ã®Firebaseè¨­å®š
        // 1. Firebase Console (https://console.firebase.google.com/) ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        // 2. ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’è¿½åŠ ã—ã¦ã€ä»¥ä¸‹ã®å€¤ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
        // 3. Authenticationãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã€ŒåŒ¿å(Anonymous)èªè¨¼ã€ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
        // ================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ================================================================

        let app, auth, db;
        const appId = "memo-magic-v1";

        // Firebaseã®åˆæœŸåŒ–ï¼ˆè¨­å®šãŒæ­£ã—ã„å ´åˆã®ã¿ï¼‰
        const isConfigValid = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";
        
        if (isConfigValid) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                window.db = db;
                window.auth = auth;
                window.appId = appId;

                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã‚’é–‹å§‹
                onAuthStateChanged(auth, (user) => { 
                    if (user) {
                        window.currentUser = user;
                        if (window.loadCloudData) window.loadCloudData();
                    } else {
                        signInAnonymously(auth).catch(e => console.error("åŒ¿åèªè¨¼å¤±æ•—:", e));
                    }
                });
            } catch (e) {
                console.error("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            }
        } else {
            console.warn("Firebaseã®è¨­å®šãŒæœªå…¥åŠ›ã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜æ©Ÿèƒ½ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚");
        }

        window.initCloud = async () => {
            if (window.auth) {
                try {
                    await signInAnonymously(window.auth);
                } catch (e) {
                    console.error("åŒ¿åèªè¨¼å¤±æ•—:", e);
                }
            }
        };
    </script>

    <style>
        :root {
            --ios-yellow: #ffb400;
            --ios-gray: #8e8e93;
            --bg-color: #f2f2f7;
            --cell-bg: #ffffff;
            --border-color: #c6c6c8;
            --ios-red: #ff3b30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; user-select: none; -webkit-user-select: none;
            overflow-x: hidden; color: #000;
            padding-top: env(safe-area-inset-top);
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 16px; height: 44px; position: sticky; top: 0; z-index: 100;
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 0.5px solid var(--border-color);
        }

        .back-button {
            color: var(--ios-yellow); font-size: 17px; cursor: pointer;
            display: flex; align-items: center;
        }

        .back-button::before {
            content: ""; display: inline-block; width: 10px; height: 10px;
            border-left: 2px solid var(--ios-yellow); border-bottom: 2px solid var(--ios-yellow);
            transform: rotate(45deg); margin-right: 8px;
        }

        .yellow-btn { color: var(--ios-yellow); font-weight: 600; font-size: 17px; cursor: pointer; }
        .red-btn { color: var(--ios-red); font-weight: 600; font-size: 17px; cursor: pointer; }

        .title-large { font-size: 34px; font-weight: 700; padding: 0 16px 10px 16px; margin: 0; }
        .section-title { font-size: 13px; color: var(--ios-gray); text-transform: uppercase; padding: 20px 16px 8px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 16px; }
        .card {
            background: var(--cell-bg); border-radius: 12px; height: 80px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 600; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: opacity 0.1s; cursor: pointer;
        }
        .card:active { opacity: 0.7; }
        .card small { font-weight: 400; font-size: 11px; color: var(--ios-gray); margin-top: 4px; }

        .selection-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 8px; padding: 16px; background: var(--bg-color);
        }
        .select-btn-mini {
            background: white; border-radius: 8px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
        }
        .has-ref::after {
            content: "â—"; color: var(--ios-yellow); position: absolute; top: 2px; right: 4px; font-size: 8px;
        }

        .upload-box {
            width: 100%; aspect-ratio: 16/9; border: 2px dashed var(--border-color);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            background: #fff; cursor: pointer; overflow: hidden; position: relative;
        }
        .upload-box img { width: 100%; height: 100%; object-fit: cover; }
        .upload-box span { font-size: 14px; color: var(--ios-gray); }

        #final-image { width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; }

        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 2000;
            padding: 20px;
        }
        .modal-content {
            background: white; border-radius: 12px; width: 100%; max-width: 300px;
            padding: 20px; text-align: center;
        }
        .modal-input {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; margin: 15px 0; box-sizing: border-box; font-size: 16px;
        }

        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--ios-yellow); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        .timestamp { color: var(--ios-gray); font-size: 13px; text-align: center; padding: 10px 0; }
        .settings-icon { font-size: 24px; cursor: pointer; color: var(--ios-yellow); }

        .settings-group { background: white; border-top: 0.5px solid var(--border-color); border-bottom: 0.5px solid var(--border-color); margin-top: 20px; }
        .settings-row { display: flex; align-items: center; padding: 12px 16px; border-bottom: 0.5px solid var(--border-color); }
        .settings-row input { flex-grow: 1; border: none; outline: none; font-size: 15px; }

        .error-message { background: #ffe5e5; color: #d8000c; padding: 10px; border-radius: 8px; margin: 10px; font-size: 14px; text-align: center; display: none; }

        .scrollable-content {
            height: calc(100vh - 44px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; background-color: var(--bg-color); padding: 20px; text-align: center;
        }
        .login-logo { font-size: 60px; margin-bottom: 20px; }
        .login-input {
            width: 100%; max-width: 250px; padding: 12px 16px; border-radius: 10px;
            border: 1px solid var(--border-color); font-size: 17px; margin-bottom: 20px;
            outline: none; text-align: center; background: white;
            -webkit-user-select: text; user-select: text;
        }
        .login-btn {
            width: 100%; max-width: 250px; background-color: var(--ios-yellow);
            color: white; font-weight: 700; padding: 14px; border-radius: 10px; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="screen-login" class="login-screen">
        <div class="login-logo">ğŸ“</div>
        <h2 style="margin-bottom: 20px; font-weight: 700;">ãƒ¡ãƒ¢</h2>
        <input type="password" id="app-password" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <div class="login-btn" onclick="checkAppPassword()">ãƒ­ã‚°ã‚¤ãƒ³</div>
        <p id="login-error" style="color: var(--ios-red); font-size: 13px; margin-top: 15px; display: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</p>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="hidden">
        <div class="header">
            <div></div>
            <div class="settings-icon" onclick="goToSettings('screen-home')">âš™ï¸</div>
        </div>
        <div class="scrollable-content">
            <h1 class="title-large" style="margin-top: 10px;">ãƒ¡ãƒ¢</h1>
            <div class="section-title">ãƒ¡ãƒ¢äºˆè¨€ (ãƒ†ã‚­ã‚¹ãƒˆ)</div>
            <div class="grid">
                <div class="card" onclick="startMemoMagic('MBTI')">MBTI<small>ãƒ†ã‚­ã‚¹ãƒˆ</small></div>
                <div class="card" onclick="startMemoMagic('æ˜Ÿåº§')">æ˜Ÿåº§<small>ãƒ†ã‚­ã‚¹ãƒˆ</small></div>
            </div>
            <div class="section-title">ç”»åƒäºˆè¨€</div>
            <div class="grid">
                <div class="card" onclick="initExecutionFlow()">ç”»åƒç”Ÿæˆ<small>ãƒã‚¸ãƒƒã‚¯æœ¬ç•ª</small></div>
                <div class="card" onclick="initStorageFlow()">å‚è€ƒç”»åƒ<small>äº‹å‰ä¿å­˜</small></div>
            </div>
            <div class="section-title">ã‚«ã‚¹ã‚¿ãƒ </div>
            <div class="grid">
                <div id="custom-card" class="card" style="display: none;"></div>
                <div class="card" onclick="showScreen('screen-create')" style="color: var(--ios-gray); border: 1px dashed #ccc; background: none;">ï¼‹ä½œæˆ</div>
            </div>
            <div id="cloud-status-text" style="font-size: 11px; text-align: center; color: var(--ios-gray); margin-top: 10px;">ã‚¯ãƒ©ã‚¦ãƒ‰æœªæ¥ç¶š</div>
            <div style="height: 100px;"></div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ¢å…¥åŠ› -->
    <div id="screen-memo-input" class="hidden" style="background: white; min-height: 100vh;">
        <div class="header">
            <div class="back-button" onclick="showScreen('screen-home')">ãƒ¡ãƒ¢</div>
            <div class="yellow-btn" onclick="showMemoSelection()">ä¿å­˜</div>
        </div>
        <textarea id="main-input" style="width:100%; border:none; outline:none; padding:20px; font-size:18px; line-height:1.4; min-height:400px; box-sizing:border-box; -webkit-user-select: text; user-select: text;"></textarea>
    </div>

    <!-- åœŸå°ç”»åƒ -->
    <div id="screen-exec-base" class="hidden">
        <div class="header"><div class="back-button" onclick="showScreen('screen-home')">æˆ»ã‚‹</div></div>
        <div style="padding: 16px;">
            <p style="font-weight: bold; margin-bottom: 10px;">åœŸå°ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
            <div class="upload-box" onclick="document.getElementById('exec-base-input').click()">
                <span id="exec-base-hint">+ ç”»åƒã‚’é¸æŠ</span>
                <img id="exec-base-preview" class="hidden">
            </div>
            <input type="file" id="exec-base-input" class="hidden" accept="image/*" onchange="handleExecBaseUpload(event)">
        </div>
    </div>

    <!-- é …ç›®é¸æŠ -->
    <div id="screen-item-selection" class="hidden">
        <div class="header"><div class="back-button" id="select-back-btn">æˆ»ã‚‹</div></div>
        <div class="scrollable-content">
            <h2 style="padding: 0 16px; margin: 10px 0;" id="select-screen-title">é …ç›®ã‚’é¸æŠ</h2>
            <div id="wrapper-freetext" style="padding: 0 16px; margin-bottom: 12px;"><div class="card" style="width:100%; height:50px;" onclick="onItemClicked('è‡ªç”±è¨˜è¿°')">è‡ªç”±è¨˜è¿°</div></div>
            <div id="wrapper-mbti"><div class="section-title">MBTI</div><div class="selection-grid" id="mbti-grid"></div></div>
            <div id="wrapper-signs"><div class="section-title">æ˜Ÿåº§</div><div class="selection-grid" id="signs-grid"></div></div>
            <div id="wrapper-custom"><div class="section-title">ã‚«ã‚¹ã‚¿ãƒ é …ç›®<span id="btn-delete-custom" style="color: var(--ios-red); font-size: 11px; cursor: pointer; padding-left: 20px;" onclick="requestDeleteCategory()">å‰Šé™¤</span></div><div class="selection-grid" id="custom-selection-grid"></div></div>
        </div>
    </div>

    <!-- æœ€çµ‚çµæœ -->
    <div id="screen-final" class="hidden">
        <div class="header"><div class="back-button" onclick="showScreen('screen-home')">å®Œäº†</div></div>
        <div style="padding: 20px;"><div id="final-text-display"></div><img id="final-image" src="" alt="Result" ondblclick="reGenerate()" class="hidden"><div id="api-error-display" class="error-message"></div></div>
    </div>

    <!-- è¨­å®š -->
    <div id="screen-settings" class="hidden">
        <div class="header"><div class="back-button" onclick="returnToPrevious()">æˆ»ã‚‹</div></div>
        <h2 style="padding: 0 16px;">è¨­å®š</h2>
        <div class="settings-group"><div class="settings-row"><label style="width:80px;">API Key</label><input type="password" id="api-key-input" placeholder="Gemini API Keyã‚’å…¥åŠ›"></div></div>
        <div id="cloud-info" style="padding: 16px; font-size: 11px; color: var(--ios-gray);">
            <p>Cloud Sync Status: <span id="sync-status">Inactive</span></p>
        </div>
    </div>

    <div id="screen-create" class="hidden">
        <div class="header"><div class="back-button" onclick="showScreen('screen-home')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div><div class="yellow-btn" onclick="saveCustomSettings()">ä¿å­˜</div></div>
        <div class="scrollable-content" style="background: white;"><div style="padding: 16px;"><input type="text" id="custom-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"></div><div id="input-rows"></div></div>
    </div>

    <div id="screen-storage-upload" class="hidden">
        <div class="header"><div class="back-button" onclick="showScreen('screen-item-selection')">æˆ»ã‚‹</div></div>
        <div style="padding: 20px; text-align: center;">
            <h2 id="storage-item-name">é …ç›®å</h2>
            <div class="upload-box" onclick="document.getElementById('storage-input').click()" style="aspect-ratio: 1;"><span id="storage-hint">+ å‚è€ƒç”»åƒã‚’ä¿å­˜</span><img id="storage-preview" class="hidden"></div>
            <input type="file" id="storage-input" class="hidden" accept="image/*" onchange="handleStorageUpload(event)">
            <div class="yellow-btn" style="margin-top: 30px;" onclick="deleteSavedRef()">å‰Šé™¤ã™ã‚‹</div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-freetext" class="modal"><div class="modal-content"><h3>è‡ªç”±è¨˜è¿°</h3><input type="text" id="free-text-input" class="modal-input"><div style="display:flex;gap:10px;"><div class="card" onclick="closeModal('modal-freetext')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div><div class="card" onclick="confirmFreeText()">å®Œäº†</div></div></div></div>
    <div id="modal-delete-confirm" class="modal"><div class="modal-content"><h3>ç¢ºèª</h3><p>å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p><div style="display:flex;gap:10px;"><div class="card" onclick="closeModal('modal-delete-confirm')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div><div class="card" onclick="confirmDeleteCategory()">å‰Šé™¤</div></div></div></div>
    <div id="loading" class="loading-overlay"><div class="spinner"></div><p id="loading-text">å‡¦ç†ä¸­...</p></div>

    <script type="module">
        import { doc, setDoc, getDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const MASTER_PASSWORD = "desuwayo";
        let savedReferences = {};
        let customData = [];
        let customTitle = "";
        let flowMode = ""; let currentCategory = ""; 
        let baseImageBase64 = ""; let baseImageMimeType = "image/png";
        let currentEditingItem = ""; let previousScreen = "screen-home";
        let isGenerating = false; 

        window.checkAppPassword = function() {
            if (document.getElementById('app-password').value === MASTER_PASSWORD) {
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-home').classList.remove('hidden');
            } else { document.getElementById('login-error').style.display = 'block'; }
        }

        // åˆæœŸUIæ§‹ç¯‰
        const mbtis = ['INTJ','INTP','ENTJ','ENTP','INFJ','INFP','ENFJ','ENFP','ISTJ','ISFJ','ESTJ','ESFJ','ISTP','ISFP','ESTP','ESFP'];
        const signs = ['ãŠã²ã¤ã˜','ãŠã†ã—','ãµãŸã”','ã‹ã«','ã—ã—','ãŠã¨ã‚','ã¦ã‚“ã³ã‚“','ã•ãã‚Š','ã„ã¦','ã‚„ã','ã¿ãšãŒã‚','ã†ãŠ'];
        
        mbtis.forEach(m => {
            const d = document.createElement('div'); d.className = 'select-btn-mini'; d.innerText = m; 
            d.onclick = () => onItemClicked(m); document.getElementById('mbti-grid').appendChild(d);
        });
        signs.forEach(s => {
            const d = document.createElement('div'); d.className = 'select-btn-mini'; d.innerText = s; 
            d.onclick = () => onItemClicked(s); document.getElementById('signs-grid').appendChild(d);
        });

        const rowCont = document.getElementById('input-rows');
        for(let i=1; i<=100; i++) {
            rowCont.innerHTML += `<div style="display:flex;padding:10px 16px;border-bottom:0.5px solid #eee;"><span style="width:30px;">${i}</span><input type="text" class="c-input" style="border:none;width:100%;outline:none;"></div>`;
        }

        window.loadCloudData = async function() {
            if (!window.db || !window.currentUser) return;
            try {
                const setSnap = await getDoc(doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'settings', 'customPredict'));
                if (setSnap.exists()) { customTitle = setSnap.data().title; customData = setSnap.data().list; updateCustomCard(); }
                
                const refSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'references'));
                savedReferences = {}; refSnap.forEach(doc => { savedReferences[doc.id] = doc.data().data; });
                
                document.getElementById('cloud-status-text').innerText = "ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæ¸ˆã¿";
                document.getElementById('sync-status').innerText = "Connected";
            } catch(e) { console.error("Data load failed", e); }
        }

        window.showScreen = function(id) {
            document.querySelectorAll('body > div:not(.loading-overlay):not(.modal)').forEach(div => div.classList.add('hidden'));
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
            if (id === 'screen-item-selection') { updateGridVisibility(); updateGridIndicators(); }
        }

        function updateGridVisibility() {
            const wrappers = {'MBTI': document.getElementById('wrapper-mbti'), 'æ˜Ÿåº§': document.getElementById('wrapper-signs'), 'CUSTOM': document.getElementById('wrapper-custom')};
            Object.values(wrappers).forEach(w => w && w.classList.add('hidden'));
            if (flowMode === "MEMO" || (flowMode === "EXEC" && currentCategory !== "")) {
                if (currentCategory && wrappers[currentCategory]) wrappers[currentCategory].classList.remove('hidden');
            } else { Object.values(wrappers).forEach(w => w && w.classList.remove('hidden')); }
            
            const delBtn = document.getElementById('btn-delete-custom');
            if (delBtn) delBtn.style.display = (flowMode === "STORAGE" && customData.length > 0) ? "inline" : "none";

            if (wrappers['CUSTOM'] && !wrappers['CUSTOM'].classList.contains('hidden')) renderCustomSelectionGrid();
        }

        function renderCustomSelectionGrid() {
            const grid = document.getElementById('custom-selection-grid'); grid.innerHTML = "";
            customData.forEach(item => { const d = document.createElement('div'); d.className = 'select-btn-mini'; d.innerText = item; d.onclick = () => onItemClicked(item); grid.appendChild(d); });
        }

        function updateGridIndicators() { document.querySelectorAll('.select-btn-mini').forEach(btn => { if (savedReferences[btn.innerText]) btn.classList.add('has-ref'); else btn.classList.remove('has-ref'); }); }

        window.goToSettings = (f) => { previousScreen = f; window.showScreen('screen-settings'); }
        window.returnToPrevious = () => window.showScreen(previousScreen);
        window.startMemoMagic = (m) => { currentCategory = m; window.showScreen('screen-memo-input'); }
        window.showMemoSelection = () => { flowMode = "MEMO"; window.showScreen('screen-item-selection'); }
        window.initStorageFlow = () => { flowMode = "STORAGE"; currentCategory = ""; window.showScreen('screen-item-selection'); }
        window.initExecutionFlow = () => { flowMode = "EXEC"; currentCategory = ""; window.showScreen('screen-exec-base'); }

        window.handleExecBaseUpload = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                baseImageBase64 = ev.target.result.split(',')[1];
                document.getElementById('exec-base-preview').src = ev.target.result;
                document.getElementById('exec-base-preview').classList.remove('hidden');
                window.showScreen('screen-item-selection');
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        window.handleStorageUpload = (e) => {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                savedReferences[currentEditingItem] = ev.target.result;
                document.getElementById('storage-preview').src = ev.target.result;
                document.getElementById('storage-preview').classList.remove('hidden');
                if (window.currentUser && window.db) await setDoc(doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'references', currentEditingItem), { data: ev.target.result });
                updateGridIndicators();
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        window.deleteSavedRef = async () => {
            delete savedReferences[currentEditingItem];
            document.getElementById('storage-preview').classList.add('hidden');
            if (window.currentUser && window.db) await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'references', currentEditingItem));
            updateGridIndicators();
        }

        window.onItemClicked = (item) => {
            currentEditingItem = item;
            if (flowMode === "STORAGE") {
                document.getElementById('storage-item-name').innerText = item;
                const saved = savedReferences[item];
                if (saved) { document.getElementById('storage-preview').src = saved; document.getElementById('storage-preview').classList.remove('hidden'); }
                else { document.getElementById('storage-preview').classList.add('hidden'); }
                window.showScreen('screen-storage-upload');
            } else if (flowMode === "MEMO") {
                if (item === 'è‡ªç”±è¨˜è¿°') document.getElementById('modal-freetext').style.display = 'flex';
                else completeMemoMagic(item);
            } else {
                if (item === 'è‡ªç”±è¨˜è¿°') document.getElementById('modal-freetext').style.display = 'flex';
                else executeMagic(item);
            }
        }

        async function executeMagic(item) {
            const apiKey = document.getElementById('api-key-input').value;
            if (!apiKey) { alert("âš™ï¸è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            document.getElementById('loading').style.display = 'flex';
            const refData = savedReferences[item];
            let parts = [{ text: "Compositing for prediction: " + item }, { inlineData: { mimeType: "image/png", data: baseImageBase64 } }];
            if (refData) parts.push({ inlineData: { mimeType: "image/png", data: refData.split(',')[1] } });
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts }], generationConfig: { responseModalities: ["TEXT", "IMAGE"] } })
                });
                const res = await response.json();
                const out64 = res.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                document.getElementById('final-image').src = `data:image/png;base64,${out64}`;
                document.getElementById('final-image').classList.remove('hidden');
                document.getElementById('final-text-display').innerText = "";
                window.showScreen('screen-final');
            } catch(e) { alert("ç”Ÿæˆå¤±æ•—: " + e.message); } finally { document.getElementById('loading').style.display = 'none'; }
        }

        function completeMemoMagic(item) {
            document.getElementById('final-text-display').innerText = document.getElementById('main-input').value + "\n\n" + item;
            document.getElementById('final-image').classList.add('hidden');
            window.showScreen('screen-final');
        }

        window.saveCustomSettings = async function() {
            customTitle = document.getElementById('custom-title').value;
            customData = Array.from(document.querySelectorAll('.c-input')).map(i => i.value.trim()).filter(v => v !== "");
            updateCustomCard(); window.showScreen('screen-home');
            if (window.currentUser && window.db) await setDoc(doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'settings', 'customPredict'), { title: customTitle, list: customData });
        }

        window.requestDeleteCategory = () => document.getElementById('modal-delete-confirm').style.display = 'flex';
        window.confirmDeleteCategory = async () => {
            document.getElementById('modal-delete-confirm').style.display = 'none';
            customTitle = ""; customData = []; updateCustomCard();
            if (window.currentUser && window.db) await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'settings', 'customPredict'));
            window.showScreen('screen-home');
        };

        function updateCustomCard() { const card = document.getElementById('custom-card'); if(customTitle) { card.innerHTML = `${customTitle}<small>ã‚«ã‚¹ã‚¿ãƒ </small>`; card.style.display = 'flex'; card.onclick = () => window.startMemoMagic('CUSTOM'); } else { card.style.display = "none"; } }
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.confirmFreeText = () => { const v = document.getElementById('free-text-input').value; window.closeModal('modal-freetext'); if (flowMode === "MEMO") completeMemoMagic(v); else executeMagic(v); };
        window.reGenerate = () => executeMagic(currentEditingItem);
    </script>
</body>
</html>